{% extends "dashboard_base.html" %}
{% block dashboard_content %}

<!-- Themed Header -->
<div class="user-promo-header">
    <div class="header-content">
        <h1><i class="fas fa-eye icon-header"></i> Quick Review Sessions</h1>
        <p class="subtitle">Group videos into sessions for streamlined reviewing.</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openQuickReviewModal()">
            <i class="fas fa-plus"></i> Create Session
        </button>
        <button class="btn btn-danger" onclick="clearAllSessions()">
            <i class="fas fa-trash"></i> Clear All
        </button>
    </div>
</div>

<div class="quick-review-container">
    <!-- This is the original body of the page, with functionality restored -->
    
    {% if sessions %}
    <div class="qr-sessions">
        {% for session in sessions %}
        <div class="session-card" onclick="loadSession('{{ session.name }}')">
            <div class="session-title">{{ session.name }}</div>
            <div class="session-date">Created: {{ (session.created_at | localtime).strftime('%b %d, %Y') }}</div>
            <div class="session-count">
                <i class="fas fa-video"></i> {{ session.item_count }} items
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">
          <i class="fas fa-folder-open"></i>
      </div>
      <div class="empty-state-text">No review sessions yet</div>
      <button class="btn btn-primary" onclick="openQuickReviewModal()">
        Create your first session
      </button>
    </div>
    {% endif %}

    <div class="qr-table-container" id="sessionTableContainer">
        <div class="qr-table-header">
          <h3 id="sessionLabel">Session Details</h3>
          <div id="reviewedCountBox" style="font-size: 1rem; color: var(--primary); font-weight: 500; margin-right: 18px;"></div>
          <div class="session-actions">
            <button onclick="verifySession()" class="btn btn-primary">
              <i class="fas fa-check-circle"></i> Verify Session
            </button>
            <button onclick="closeSessionView()" class="btn btn-secondary">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="qr-table" id="sessionTable">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Episode</th>
                <th>Status</th>
                <th class="comment-header">Upload Comment</th>
                <th class="action-header">Action</th>
              </tr>
            </thead>
            <tbody id="sessionBody"></tbody>
          </table>
        </div>
        
        <div class="verification-box" id="verificationBox" style="display: none;">
            <div class="verification-icon"><i class="fas fa-check-circle"></i></div>
            <div class="verification-text">
                <h4>Session Verified</h4>
                <p>All items in this session have been reviewed and approved.</p>
            </div>
        </div>
    </div>
</div>

<!-- Original Create Session Modal -->
<div class="qr-modal" id="quickReviewModal">
  <div class="qr-modal-content">
    <div class="modal-header">
      <h3>Create New Review Session</h3>
      <span class="close-btn" onclick="closeQuickReviewModal()">&times;</span>
    </div>
    <p style="color: #718096; margin-bottom: 20px;">Select videos to include in this review session</p>
    <form method="POST" action="/create_quick_review">
      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" onclick="toggleAllVideos(event)">
          <span>Select All Videos</span>
        </label>
      </div>
      <div id="modalVideoList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px;">
        {% if under_review_videos %}
          {% for video in under_review_videos %}
            <div class="video-select-item">
              <input type="checkbox" name="selected_videos" value="{{ video.subject }}||{{ video.episode }}" id="video_{{ loop.index }}" class="qrModalCheckbox">
              <label for="video_{{ loop.index }}">{{ video.subject }} â€“ {{ video.episode }}</label>
            </div>
          {% endfor %}
        {% else %}
          <div style="padding: 20px; text-align: center; color: #718096;">No videos available for review</div>
        {% endif %}
      </div>
      <input type="text" name="session_name" class="session-name-input" placeholder="Enter session name" required>
      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeQuickReviewModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" {% if not under_review_videos %}disabled{% endif %}>Create Session</button>
      </div>
    </form>
  </div>
</div>

<style>
/* Themed Header */
:root {
    --primary: #37b3ba;
    --primary-dark: #2a8b91;
    --primary-bg: rgba(55, 179, 186, 0.1);
    --success: #16a34a; /* Green */
    --success-dark: #15803d;
    --success-bg: rgba(22, 163, 74, 0.1);
    --light-gray: #f8f9fa;
    --medium-gray: #6c757d;
    --dark-gray: #343a40;
    --border-color: #dee2e6;
    --border-radius: 0.5rem;
    --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}
.user-promo-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; background: var(--primary); color: white; border-radius: 12px; }
.user-promo-header h1 { font-size: 1.75rem; margin: 0; display: flex; align-items: center; gap: 0.75rem; color: white; }
.user-promo-header .subtitle { margin-top: 0.25rem; font-size: 0.95rem; color: rgba(255, 255, 255, 0.9); }
.user-promo-header .btn { padding: 0.6rem 1.2rem; border-radius: var(--border-radius); font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; border: 1px solid transparent; }
.user-promo-header .btn-primary { background: white; color: var(--primary-dark); font-weight: 600; }
.user-promo-header .btn-primary:hover { background: rgba(255, 255, 255, 0.9); }
.user-promo-header .btn-danger { background: #f1f5f9; color: #ef4444; }
.user-promo-header .btn-danger:hover { background: #fee2e2; }

/* Original Styles (Themed) */
.quick-review-container { padding: 25px; background: #f8fafc; border-radius: 12px; }
.qr-sessions { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
.session-card { background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden; }
.session-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-color: var(--primary-bg); }
.session-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
.session-title { font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 1.1rem; }
.session-date { color: #718096; font-size: 0.9rem; }
.session-count { margin-top: 10px; font-size: 0.85rem; color: #4a5568; display: flex; align-items: center; gap: 5px; }

/* Table Design */
.qr-table-container { background: #fff; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); padding: 18px; margin-top: 28px; border: 1px solid #e2e8f0; display: none; }
.qr-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.qr-table-header h3 { font-size: 1.3rem; color: #2d3748; font-weight: 600; margin: 0; }
.session-actions { display: flex; gap: 10px; }
.qr-table { width: 100%; border-collapse: collapse; font-size: 0.93rem; }
.qr-table th, .qr-table td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; text-align: left; vertical-align: middle; }
.qr-table th { background: #f1f5f9; color: #374151; font-weight: 600; }
.qr-table .comment-header { width: auto; }
.qr-table .action-header { width: auto; text-align: center; }
.qr-table tr:hover td { background: #f9fafb; }

.comment-filename {
    display: inline-block;
    vertical-align: middle;
    max-width: 350px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Verification Box */
.verification-box { background: var(--success-bg); border: 1px solid var(--success); border-radius: 8px; padding: 15px; margin-top: 20px; display: flex; align-items: center; gap: 15px; }
.verification-icon { font-size: 1.5rem; color: var(--primary-dark); }
.verification-text h4 { margin: 0 0 5px 0; color: var(--primary-dark); }
.verification-text p { margin: 0; color: #4b5563; font-size: 0.9rem; }

/* Empty State */
.empty-state { text-align: center; padding: 40px 20px; color: #718096; }
.empty-state-icon { font-size: 3rem; margin-bottom: 15px; color: #cbd5e0; }
.empty-state-text { font-size: 1.1rem; margin-bottom: 20px; }

/* General Buttons */
.btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: #e2e8f0; color: #4a5568; }
.btn-secondary:hover { background: #cbd5e0; }

/* Status Badges */
.status-badge { padding: 3px 10px; border-radius: 10px; font-size: 0.78rem; }
.badge-reviewed { background: var(--success-bg); color: var(--success-dark); }
.badge-pending { background: #fee2e2; color: #991b1b; }

/* Modal Styles */
.qr-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30, 41, 59, 0.55); z-index: 1000; justify-content: center; align-items: center; }
.qr-modal-content { background: #fff; padding: 28px; border-radius: 14px; max-height: 80vh; overflow-y: auto; width: 420px; box-shadow: 0 8px 32px rgba(0,0,0,0.13); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; }
.modal-header h3 { font-size: 1.18rem; color: #22223b; font-weight: 700; margin: 0; }
.close-btn { font-size: 1.5rem; color: #a0aec0; cursor: pointer; border: none; background: none; }
.close-btn:hover { color: #e53e3e; }
.video-select-item { display: flex; align-items: center; gap: 10px; padding: 7px 0; }
.session-name-input { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 18px; }
.qr-modal-content .btn-primary:disabled { background: #c6f6d5; cursor: not-allowed; }

/* Upload Form */
.upload-container { display: flex; align-items: center; gap: 10px; }
.file-input { width: 100%; max-width: 350px; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; }
.upload-btn { background: var(--primary); color: white; font-size: 0.88rem; padding: 6px 12px; }
.upload-btn:hover { background: var(--primary-dark); }

/* Review Action Button */
.review-btn { padding: 6px 12px; font-size: 0.9rem; width: 150px; justify-content: center; }
.review-btn.reviewed { background: var(--success); color: white; }
.review-btn.reviewed:hover { background: var(--success-dark); }
.review-btn.unreviewed { background: #e2e8f0; color: #4a5568; }
.review-btn.unreviewed:hover { background: #cbd5e0; }
</style>

<!-- Original full-featured JavaScript -->
<script id="sessionData" type="application/json">{{ session_json | tojson | safe }}</script>
<script>
  let currentSession = null;
  let sessionData = JSON.parse(document.getElementById('sessionData').textContent);

  function openQuickReviewModal() {
    document.getElementById('quickReviewModal').style.display = 'flex';
  }

  function closeQuickReviewModal() {
    document.getElementById('quickReviewModal').style.display = 'none';
  }

  function toggleAllVideos(event) {
    const checkboxes = document.querySelectorAll('.qrModalCheckbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = event.target.checked;
    });
  }

  function loadSession(name) {
    if (!sessionData[name]) return;
    
    currentSession = name;
    document.getElementById('sessionLabel').textContent = "Session: " + name;
    const tbody = document.getElementById('sessionBody');
    tbody.innerHTML = "";

    updateReviewedCount();

    let items = [...sessionData[name]];
    items.forEach(item => {
      const row = document.createElement('tr');
      const hasComment = item.comment_file_name && item.comment_file_name.length > 0;
      row.innerHTML = `
        <td>${item.subject}</td>
        <td>${item.episode}</td>
        <td><span class="status-badge ${item.is_reviewed ? 'badge-reviewed' : 'badge-pending'}">${item.is_reviewed ? 'Reviewed' : 'Pending'}</span></td>
        <td data-item-id="${item.id}">
          ${ hasComment
            ? `<div class="upload-container">
                 <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.2rem;"></i>
                 <span class="comment-filename" style="margin-left: 8px;" title="${item.comment_file_name}">${item.comment_file_name}</span>
                 <button class="btn btn-secondary" onclick="clearComment(event, ${item.id})" style="margin-left: 10px; padding: 4px 8px; font-size: 0.8rem;">Clear</button>
               </div>`
            : `<form class="upload-form">
                 <input type="hidden" name="item_id" value="${item.id}">
                 <input type="hidden" name="subject" value="${item.subject}">
                 <input type="hidden" name="episode" value="${item.episode}">
                 <div class="upload-container">
                   <input type="file" name="comment_file" class="file-input" required>
                   <button type="submit" class="btn upload-btn"><i class="fas fa-upload" style="margin-right: 6px;"></i> Upload</button>
                 </div>
               </form>`
          }
        </td>
        <td style="text-align: center;">
          <button class="btn review-btn ${item.is_reviewed ? 'reviewed' : 'unreviewed'}" onclick="toggleReviewed(event, ${item.id})" data-reviewed="${item.is_reviewed}">
            <i class="fas ${item.is_reviewed ? 'fa-check-double' : 'fa-check'}" style="margin-right: 6px;"></i>
            <span>${item.is_reviewed ? 'Reviewed' : 'Mark Review'}</span>
          </button>
        </td>`;
      tbody.appendChild(row);
      
      const uploadForm = row.querySelector('.upload-form');
      if(uploadForm) {
          uploadForm.addEventListener('submit', handleUpload)
      }
    });

    document.getElementById('sessionTableContainer').style.display = 'block';
    document.getElementById('verificationBox').style.display = 'none';
    document.getElementById('sessionTableContainer').scrollIntoView({ behavior: 'smooth' });
  }

  function closeSessionView() {
    document.getElementById('sessionTableContainer').style.display = 'none';
    currentSession = null;
  }

  function toggleReviewed(event, itemId) {
    const button = event.currentTarget;
    const isReviewed = button.getAttribute('data-reviewed') === 'true';

    fetch('/mark_reviewed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ item_id: itemId, reviewed: !isReviewed })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const item = sessionData[currentSession].find(i => i.id === itemId);
        if (item) item.is_reviewed = !isReviewed;
        button.setAttribute('data-reviewed', (!isReviewed).toString());
        button.innerHTML = `<i class="fas ${!isReviewed ? 'fa-check-double' : 'fa-check'}" style="margin-right: 6px;"></i> <span>${!isReviewed ? 'Reviewed' : 'Mark Review'}</span>`;
        button.className = `btn review-btn ${!isReviewed ? 'reviewed' : 'unreviewed'}`;
        const badge = button.closest('tr').querySelector('.status-badge');
        badge.textContent = !isReviewed ? 'Reviewed' : 'Pending';
        badge.className = `status-badge ${!isReviewed ? 'badge-reviewed' : 'badge-pending'}`;
        updateReviewedCount();
      }
    });
  }

  function updateReviewedCount() {
    if (!currentSession) return;
    const reviewedCount = sessionData[currentSession].filter(i => i.is_reviewed).length;
    const totalCount = sessionData[currentSession].length;
    document.getElementById('reviewedCountBox').textContent = `Reviewed: ${reviewedCount} / ${totalCount}`;
  }

  function verifySession() {
    if (!currentSession) return;
    const allReviewed = sessionData[currentSession].every(item => item.is_reviewed);
    if (allReviewed) {
      document.getElementById('verificationBox').style.display = 'flex';
    } else {
      alert('Not all items have been reviewed yet!');
    }
  }

  function clearAllSessions() {
    if (confirm('Are you sure you want to delete ALL review sessions? This action cannot be undone.')) {
      fetch('/clear_all_quick_review_sessions', {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message || 'All sessions cleared successfully.');
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || 'Could not clear sessions.'));
        }
      });
    }
  }

  function handleUpload(event) {
      event.preventDefault();
      const form = event.currentTarget;
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i> Uploading...';

      fetch("{{ url_for('upload_comment') }}", {
          method: 'POST', body: formData
      })
      .then(res => res.json())
      .then(data => {
          if (data.success) {
              const uploadCell = form.closest('td');
              const itemId = form.querySelector('input[name="item_id"]').value;
              const item = sessionData[currentSession].find(i => i.id == itemId);
              if (item) item.comment_file_name = data.filename;
              uploadCell.innerHTML = `
                <div class="upload-container">
                  <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.2rem;"></i>
                  <span class="comment-filename" style="margin-left: 8px;" title="${data.filename}">${data.filename}</span>
                  <button class="btn btn-secondary" onclick="clearComment(event, ${itemId})" style="margin-left: 10px; padding: 4px 8px; font-size: 0.8rem;">Clear</button>
                </div>`;
          } else {
              alert('Upload failed: ' + (data.error || 'Unknown error'));
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-upload" style="margin-right: 6px;"></i> Upload';
          }
      });
  }
  
  function clearComment(event, itemId) {
      event.preventDefault();
      if (!confirm('Are you sure you want to clear this comment?')) return;
      
      const button = event.currentTarget;
      const uploadCell = button.closest('td');

      fetch(`/clear_comment/${itemId}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
          if(data.success) {
              const item = sessionData[currentSession].find(i => i.id == itemId);
              if (item) {
                item.comment_file_name = null;
              }
              
              // Revert the cell to show the upload form again
              uploadCell.innerHTML = `
                <form class="upload-form">
                    <input type="hidden" name="item_id" value="${item.id}">
                    <input type="hidden" name="subject" value="${item.subject}">
                    <input type="hidden" name="episode" value="${item.episode}">
                    <div class="upload-container">
                      <input type="file" name="comment_file" class="file-input" required>
                      <button type="submit" class="btn upload-btn"><i class="fas fa-upload" style="margin-right: 6px;"></i> Upload</button>
                    </div>
                </form>`;

              // Re-attach the submit event listener to the new form
              const newForm = uploadCell.querySelector('.upload-form');
              if(newForm) {
                  newForm.addEventListener('submit', handleUpload);
              }
          } else {
              alert('Error clearing comment: ' + (data.error || 'Unknown error'));
          }
      });
  }
</script>

{% endblock %}